{% extends "admin_base.html" %}
{% load static %}

{% block content %}

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
*{
    box-sizing:border-box;
    margin:0;
    padding:0;
    font-family:'Poppins','Segoe UI',sans-serif;
}

body{
    background:#f1f5f9;
}

/* ===== PAGE OVERLAY ===== */
.page-overlay{
    background:rgba(241,245,249,0.85);
    backdrop-filter:blur(6px);
    min-height:100vh;
    padding-bottom:40px;
}

/* ===== BANNER ===== */
.banner{
    height:360px;
    background:url("{% static 'images/store.jpeg' %}") center/cover no-repeat;
}

.banner-overlay{
    height:100%;
    background:linear-gradient(90deg,rgba(30,30,20,0.7),rgba(0,0,0,0.3));
    display:flex;
    align-items:center;
}

.banner-content{
    margin-left:6vw;
    color:#fff;
}

.banner-content h1{
    font-size:38px;
    margin-bottom:8px;
}

/* ===== MAIN GRID ===== */
.main-container{
    max-width:1200px;
    margin:40px auto;
    padding:0 18px;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:32px;
}

/* ===== GLASS CARD ===== */
.glass-card{
    background:rgba(255,255,255,0.35);
    backdrop-filter:blur(22px);
    border-radius:22px;
    padding:30px;
    border:1px solid rgba(255,255,255,0.35);
    box-shadow:0 25px 60px rgba(0,0,0,0.18);
}

/* ðŸ”¥ Store Details card flex */
.glass-card.store-details{
    display:flex;
    flex-direction:column;
}

/* ===== CARD TITLE BAR ===== */
.section-title{
    margin:-30px -30px 22px -30px;
    padding:16px 20px;
    background:#0e7490;
    color:#fff;
    font-size:22px;
    font-weight:600;
    text-align:center;
    border-radius:22px 22px 0 0;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
}

/* ===== FORM ===== */
.form-grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:18px 22px;
}

.form-group{
    display:flex;
    flex-direction:column;
    gap:8px;
}

.form-group.full{
    grid-column:1 / -1;
}

label{
    font-size:13px;
    font-weight:600;
}

input, select, textarea{
    width:100%;
    height:46px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #cbd5e1;
    font-size:14px;
}

textarea{
    resize:vertical;
}

/* âœ… Description height increased */
textarea[name="description"]{
    min-height:160px;
}

/* ===== SUBMIT ===== */
.submit-wrapper{
    margin-top:auto;          /* ðŸ”¥ pushes button to bottom */
    display:flex;
    justify-content:center;
    padding-top:30px;
}

#submitBtn{
    width:220px;
    height:50px;
    border:none;
    border-radius:18px;
    background:linear-gradient(135deg,#0e7490,#0891b2);
    color:#fff;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
}

#submitBtn:disabled{
    opacity:0.6;
    cursor:not-allowed;
}

/* ===== LOCATION SEARCH ===== */
.search-box{
    display:flex;
    gap:10px;
    margin-bottom:14px;
}

.search-box input{
    flex:1;
}

.search-box button{
    padding:0 18px;
    border:none;
    border-radius:12px;
    background:#0284c7;
    color:#fff;
    font-weight:600;
    cursor:pointer;
}

/* ===== MAP ===== */
#map{
    height:435px;
    border-radius:18px;
    margin-bottom:12px;
}

/* ===== RESPONSIVE ===== */
@media(max-width:1024px){
    .main-container{
        grid-template-columns:1fr;
    }
}

@media(max-width:700px){
    .form-grid{
        grid-template-columns:1fr;
    }
    .search-box{
        flex-direction:column;
    }
}
</style>

<div class="page-overlay">

<!-- ===== BANNER ===== -->
<section class="banner">
    <div class="banner-overlay">
        <div class="banner-content">
            <h1>Create Store</h1>
            <p>Add store details & pin exact location</p>
        </div>
    </div>
</section>

<form method="post" enctype="multipart/form-data" id="storeForm">
{% csrf_token %}

<div class="main-container">

<!-- ===== STORE DETAILS ===== -->
<div class="glass-card store-details">
    <div class="section-title">
        <i class="fa-solid fa-store"></i>
        Store Details
    </div>

    <div class="form-grid">
        {% for field in form %}
        <div class="form-group {% if field.name == 'description' %}full{% endif %}">
            {{ field.label_tag }}
            {{ field }}
        </div>
        {% endfor %}
    </div>

    <!-- âœ… Button at bottom -->
    <div class="submit-wrapper">
        <button type="submit" id="submitBtn" disabled>Create Store</button>
    </div>
</div>

<!-- ===== STORE LOCATION ===== -->
<div class="glass-card">
    <div class="section-title">
        <i class="fa-solid fa-location-dot"></i>
        Store Location
    </div>

    <div class="search-box">
        <input type="text" id="locationSearch" placeholder="Search area, landmark, city">
        <button type="button" onclick="searchLocation()">Search</button>
    </div>

    <div id="map"></div>

    <label>Detected Address</label>
    <textarea id="autoAddress" rows="2" readonly></textarea>

    <input type="hidden" name="latitude" id="latitude">
    <input type="hidden" name="longitude" id="longitude">

    <p class="hint">Search, click on map, or drag marker</p>
    <p id="status"></p>
</div>

</div>
</form>

</div>

<!-- ===== JS (UNCHANGED) ===== -->
<script>
let map, marker;
const submitBtn = document.getElementById("submitBtn");
const statusEl = document.getElementById("status");
const latInput = document.getElementById("latitude");
const lngInput = document.getElementById("longitude");
const addressBox = document.getElementById("autoAddress");

function initMap(lat = 20.5937, lng = 78.9629) {
  map = L.map("map").setView([lat, lng], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  marker = L.marker([lat, lng], { draggable: true }).addTo(map);
  setLocation(lat, lng);

  map.on("click", e => {
    marker.setLatLng(e.latlng);
    setLocation(e.latlng.lat, e.latlng.lng);
  });

  marker.on("dragend", () => {
    const p = marker.getLatLng();
    setLocation(p.lat, p.lng);
  });
}

function setLocation(lat, lng) {
  latInput.value = lat.toFixed(6);
  lngInput.value = lng.toFixed(6);
  submitBtn.disabled = false;
  statusEl.innerText = "Location selected";

  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
    .then(r => r.json())
    .then(d => addressBox.value = d.display_name || "Selected location");
}

function searchLocation() {
  const q = document.getElementById("locationSearch").value;
  if (!q) return;

  statusEl.innerText = "Searching location...";

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.length) {
        statusEl.innerText = "Location not found";
        return;
      }
      const lat = parseFloat(data[0].lat);
      const lng = parseFloat(data[0].lon);
      map.setView([lat, lng], 15);
      marker.setLatLng([lat, lng]);
      setLocation(lat, lng);
    });
}

navigator.geolocation
? navigator.geolocation.getCurrentPosition(
    p => initMap(p.coords.latitude, p.coords.longitude),
    () => initMap()
  )
: initMap();
</script>

{% endblock %}
