{% extends "base.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{
    box-sizing:border-box;
    margin:0;
    padding:0;
    font-family:'Poppins','Segoe UI',sans-serif;
}

body{
    background:#f1f5f9;
    color:#0f172a;
}

/* ===== PAGE ===== */
.page-overlay{
    background:rgba(241,245,249,0.85);
    backdrop-filter:blur(6px);
    min-height:100vh;
    padding-bottom:40px;
}

/* ===== BANNER ===== */
.banner{
    height:360px;
    background:url("{% static 'images/store.jpeg' %}") center/cover no-repeat;
}

.banner-overlay{
    height:100%;
    background:linear-gradient(90deg,rgba(30, 30, 20, 0.7),rgba(0,0,0,0.3));
    display:flex;
    align-items:center;
}

.banner-content{
    max-width:560px;
    margin-left:6vw;
    color:#fff;
}

/* ===== MAIN ===== */
.main-container{
    max-width:1200px;
    margin:40px auto;
    padding:0 18px;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:32px;
}

/* ===== CARD ===== */
.glass-card{
    background:rgba(255,255,255,0.35);
    backdrop-filter:blur(22px);
    border-radius:22px;
    padding:30px;
    border:1px solid rgba(255,255,255,0.35);
    box-shadow:0 25px 60px rgba(0,0,0,0.18);
}

.glass-card h2{
    margin-bottom:18px;
    color: white;
    text-align: center;
    align-items: center;
}

/* ===== FULL WIDTH BLUE TITLE BAR ===== */
.section-title{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;

    margin:-30px -30px 22px -30px; /* stretch to card edges */
    padding:16px 20px;

    background:#0e7490;           /* solid blue */
    color:#ffffff;

    font-size:22px;
    font-weight:600;

    border-radius:22px 22px 0 0;  /* match card top */
}

/* icon style */
.section-title i{
    font-size:18px;
    color:#ffffff;
}



/* ===== FORM ===== */
.form-grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:18px 22px;
}

.form-group{
    display:flex;
    flex-direction:column;
    gap:8px;
}

.form-group.full{
    grid-column:1 / -1;
}

label{
    font-size:13px;
    font-weight:600;
}

/* ===== INPUTS ===== */
input, select, textarea{
    width:100%;
    height:46px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #cbd5e1;
    font-size:14px;
}

textarea[name="description"]{
    min-height:120px;
    resize:vertical;
}

/* ===== SUBMIT BUTTON ===== */
.submit-wrapper{
    display:flex;
    justify-content:center;
    margin-top:26px;
}

#submitBtn{
    width:220px;
    height:50px;
    border:none;
    border-radius:18px;
    background:linear-gradient(135deg,#0e7490,#0891b2);
    color:#fff;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
}

#submitBtn:disabled{
    opacity:0.6;
    cursor:not-allowed;
}

/* ===== LOCATION SEARCH ===== */
.location-search{
    display:flex;
    gap:10px;
    margin-bottom:14px;
}

.location-search input{
    flex:1;
}

.location-search button{
    padding:0 18px;
    border:none;
    border-radius:12px;
    background:#0284c7;
    color:#fff;
    font-weight:600;
    cursor:pointer;
}

/* ===== MAP ===== */
#map{
    min-height:435px;
    border-radius:18px;
    margin-bottom:12px;
}

/* ===== DETECTED ADDRESS ===== */
#autoAddress{
    min-height:46px;
    resize:none;
    margin-bottom:0;
}

/* ===== RESPONSIVE ===== */
@media(max-width:1024px){
    .main-container{
        grid-template-columns:1fr;
    }
}

@media(max-width:700px){
    .form-grid{
        grid-template-columns:1fr;
    }

    .location-search{
        flex-direction:column;
    }
}
</style>

<div class="page-overlay">

<section class="banner">
    <div class="banner-overlay">
        <div class="banner-content">
            <h1>Register Your Store</h1>
            <p>Add store details & accurate location</p>
        </div>
    </div>
</section>

<div class="main-container">

<!-- STORE DETAILS -->
<div class="glass-card">
<h2 class="section-title">
    Store Details <i class="fa-solid fa-store"></i>
</h2>


<form method="post" enctype="multipart/form-data">
{% csrf_token %}

<div class="form-grid">
{% for field in form %}
<div class="form-group {% if field.name == 'description' %}full{% endif %}">
    {{ field.label_tag }}
    {{ field }}
</div>
{% endfor %}
</div>

<div class="submit-wrapper">
    <button id="submitBtn" disabled>Create Store</button>
</div>

</form>
</div>

<!-- STORE LOCATION -->
<div class="glass-card">
<h2 class="section-title">
    Store Location <i class="fa-solid fa-location-dot"></i>
</h2>


<div class="location-search">
    <input type="text" id="locationSearch" placeholder="Search area, landmark, city">
    <button type="button" onclick="searchLocation()">Search</button>
</div>

<div id="map"></div>

<label>Detected Address</label>
<textarea id="autoAddress" readonly></textarea>

<input type="hidden" id="latitude">
<input type="hidden" id="longitude">
</div>

</div>
</div>

<script>
let map, marker;
const btn = document.getElementById("submitBtn");
const lat = document.getElementById("latitude");
const lng = document.getElementById("longitude");
const addr = document.getElementById("autoAddress");

function initMap(latv=20.5937, lngv=78.9629){
    map = L.map("map").setView([latv, lngv], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    marker = L.marker([latv, lngv], {draggable:true}).addTo(map);
    setLoc(latv, lngv);

    map.on("click", e=>{
        marker.setLatLng(e.latlng);
        setLoc(e.latlng.lat, e.latlng.lng);
    });

    marker.on("dragend", ()=>{
        const p = marker.getLatLng();
        setLoc(p.lat, p.lng);
    });
}

function setLoc(a,b){
    lat.value = a;
    lng.value = b;
    btn.disabled = false;

    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${a}&lon=${b}`)
    .then(r=>r.json())
    .then(d=>addr.value = d.display_name || "Selected location");
}

function searchLocation(){
    const q = document.getElementById("locationSearch").value.trim();
    if(!q) return;

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
    .then(res=>res.json())
    .then(data=>{
        if(!data.length){
            alert("Location not found");
            return;
        }
        const a = parseFloat(data[0].lat);
        const b = parseFloat(data[0].lon);
        map.setView([a,b],15);
        marker.setLatLng([a,b]);
        setLoc(a,b);
    });
}

navigator.geolocation ?
navigator.geolocation.getCurrentPosition(
    p=>initMap(p.coords.latitude, p.coords.longitude),
    ()=>initMap()
) : initMap();
</script>

{% endblock %}
